import numpy as np
import pickle
import sys
import util

from random import shuffle

class datastream(object):
    def __init__(self, inputfile, config):
        fin = open(inputfile, 'rb')
        albums = []
        self.lengths = []
        self.max_length = config.max_length
        
        while True:
            try:
                album = pickle.load(fin)
                songs = []
                target = np.zeros((1, self.max_length))

                # Convert each song to a vector representation
                for song in album:
                    songs.append(util.get_song_vector(song))

                # Keep track of the length of each album
                self.lengths.append(len(songs))

                # Pad the array with zeros
                for i in range(self.max_length - len(songs)):
                    songs.append([0]*len(songs[0]))
                
                albums.append(songs)
            except EOFError:
                break
    
        self.num_features = len(songs[0])
        self.batch_id = 0
        self.album_stream = np.array(albums)
        fin.close()
        
    def next(self, batch_size=1):
        targets = np.array([]).reshape(0, self.max_length)
        
        if self.batch_id == len(self.album_stream):
            self.batch_id = 0
            
        data = self.album_stream[self.batch_id:min(
            self.batch_id + batch_size,
            len(self.album_stream))]
        length = np.array(self.lengths[self.batch_id:min(
            self.batch_id + batch_size,
            len(self.lengths))])

        data_shuffled = np.copy(data)
        for i in range(len(data)):
            target = np.zeros((1, self.max_length))
            
            indices = np.arange(length[i])
            shuffle(indices)

            for j in range(length[i]):
                data_shuffled[i][j] = data[i][indices[j]]
                target[0, indices[j]] = j

            targets = np.vstack((targets, target))
            
        self.batch_id = min(self.batch_id + batch_size,
                            len(self.album_stream))
        return data_shuffled, targets, length

    def all(self):
        targets = np.array([]).reshape(0, self.max_length)
        
        data = self.album_stream
        
        length = np.array(self.lengths)
        
        for i in range(len(data)):
            target = np.zeros((1, self.max_length))

            indices = np.arange(length[i])

            for j in range(length[i]):
                target[0, indices[j]] = j

            targets = np.vstack((targets, target))

    
        return data, targets, length

    def norm_params(self):
        avg = []
        var = []

        # Get mean and variance within each album
        for i in range(len(self.album_stream)):
            a = np.array(self.album_stream[i])
            avg.append(np.mean(a[:self.lengths[i],:],
                               axis=0))
            var.append(np.var(a[:self.lengths[i],:],
                              axis=0))

        # Get mean an std for dataset
        mean = np.mean(avg, axis=0)
        std = np.sqrt(np.mean(var, axis=0))

        return mean, std

    def normalize(self, mean, std):
        for i in range(len(self.album_stream)):
            for j in range(self.lengths[i]):
                for k in range(self.num_features):
                    self.album_stream[i, j, k] = (
                        self.album_stream[i, j, k] - mean[k]) / std[k]
